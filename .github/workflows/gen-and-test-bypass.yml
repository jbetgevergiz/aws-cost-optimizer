name: Generate and Test Bypass

on:
  workflow_dispatch:

jobs:
  gen:
    runs-on: ubuntu-latest
    steps:
      - name: Generate bypass secret
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          PROJECT_ID: prj_HuIGsFrIYoqBzTNQ5eiZ5Gqd0di3
        run: |
          set -x
          
          echo "=== Generating Bypass Secret ===" 
          RESPONSE=$(curl -s -X PATCH "https://api.vercel.com/v1/projects/$PROJECT_ID/protection-bypass" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"generate":{}}')
          
          echo "Response:"
          echo "$RESPONSE" | jq '.'
          
          # Extract secret
          SECRET=$(echo "$RESPONSE" | jq -r '.secret // empty')
          
          if [ ! -z "$SECRET" ]; then
            echo ""
            echo "✓ Secret generated: $SECRET"
            echo ""
            echo "=== Testing access with bypass ===" 
            
            # Method 1: Header
            HTTP1=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "x-vercel-protection-bypass: $SECRET" \
              https://frontend-hr3ntphz4-jasons-projects-c908ddc9.vercel.app)
            
            echo "Method 1 (Header): HTTP $HTTP1"
            
            # Method 2: Query param
            HTTP2=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://frontend-hr3ntphz4-jasons-projects-c908ddc9.vercel.app?x-vercel-protection-bypass=$SECRET")
            
            echo "Method 2 (Query): HTTP $HTTP2"
            
            if [ "$HTTP1" = "200" ] || [ "$HTTP2" = "200" ]; then
              echo ""
              echo "✅ SUCCESS - Bypass works!"
              echo "Use this command to access the app:"
              echo "curl -H 'x-vercel-protection-bypass: $SECRET' https://frontend-hr3ntphz4-jasons-projects-c908ddc9.vercel.app"
            fi
          else
            echo "✗ Failed to get secret"
            echo "Full response:"
            echo "$RESPONSE"
          fi

name: Bypass Secret to Artifact

on:
  workflow_dispatch:

jobs:
  bypass:
    runs-on: ubuntu-latest
    steps:
      - name: Generate bypass secret and save
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          PROJECT_ID: prj_HuIGsFrIYoqBzTNQ5eiZ5Gqd0di3
        run: |
          # Generate bypass secret
          RESPONSE=$(curl -s -X PATCH "https://api.vercel.com/v1/projects/$PROJECT_ID/protection-bypass" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"generate":{"note":"CLI Emergency Access"}}')
          
          SECRET=$(echo "$RESPONSE" | jq -r '.secret // empty')
          
          if [ ! -z "$SECRET" ]; then
            echo "SECRET=$SECRET" >> $GITHUB_OUTPUT
            echo "SECRET=$SECRET" > /tmp/bypass-secret.txt
            chmod 644 /tmp/bypass-secret.txt
            
            echo "Generated bypass secret (first 10 chars): ${SECRET:0:10}..."
          else
            echo "FAILED TO GENERATE SECRET"
            echo "$RESPONSE" | jq '.'
            exit 1
          fi
      
      - name: Save to artifact
        if: always()
        run: |
          if [ -f /tmp/bypass-secret.txt ]; then
            mkdir -p /tmp/artifacts
            cp /tmp/bypass-secret.txt /tmp/artifacts/
            cat /tmp/bypass-secret.txt
          fi
      
      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: bypass-secret
          path: /tmp/artifacts/
          retention-days: 1

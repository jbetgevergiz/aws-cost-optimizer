name: Output Bypass Secret

on:
  workflow_dispatch:

jobs:
  output:
    runs-on: ubuntu-latest
    outputs:
      bypass-secret: ${{ steps.gen.outputs.secret }}
    steps:
      - id: gen
        name: Generate and output bypass secret
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          PROJECT_ID: prj_HuIGsFrIYoqBzTNQ5eiZ5Gqd0di3
        run: |
          RESPONSE=$(curl -s -X PATCH "https://api.vercel.com/v1/projects/$PROJECT_ID/protection-bypass" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"generate":{"note":"Emergency CLI Access"}}')
          
          SECRET=$(echo "$RESPONSE" | jq -r '.secret // empty')
          
          if [ ! -z "$SECRET" ]; then
            echo "secret=$SECRET" >> $GITHUB_OUTPUT
            echo "✓ Secret available in outputs"
          else
            echo "✗ Failed to generate secret"
            exit 1
          fi
  
  display:
    needs: output
    runs-on: ubuntu-latest
    steps:
      - name: Show secret
        run: |
          echo "Bypass Secret: ${{ needs.output.outputs.bypass-secret }}"
          echo ""
          echo "Test command:"
          echo "curl -H 'x-vercel-protection-bypass: ${{ needs.output.outputs.bypass-secret }}' https://frontend-hr3ntphz4-jasons-projects-c908ddc9.vercel.app"

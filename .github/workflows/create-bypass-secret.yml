name: Create Bypass Secret and Test

on:
  workflow_dispatch:

jobs:
  bypass:
    runs-on: ubuntu-latest
    steps:
      - name: Create or get Automation Bypass Secret
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "=== Creating Automation Bypass Secret ===" 
          
          # Try to create a new bypass secret
          RESPONSE=$(curl -s -X POST "https://api.vercel.com/v10/projects/$VERCEL_PROJECT_ID/protection-bypass" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"description":"Emergency bypass for development"}')
          
          echo "API Response:"
          echo "$RESPONSE" | jq '.'
          
          # Try to extract the secret
          SECRET=$(echo "$RESPONSE" | jq -r '.secret // .token // empty')
          
          if [ -z "$SECRET" ]; then
            echo "Failed to get secret, trying alternative endpoint..."
            
            # Try different endpoint
            RESPONSE=$(curl -s -X POST "https://api.vercel.com/v8/projects/$VERCEL_PROJECT_ID/protection-bypass-secret" \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{}')
            echo "$RESPONSE" | jq '.'
            SECRET=$(echo "$RESPONSE" | jq -r '.secret // empty')
          fi
          
          if [ ! -z "$SECRET" ]; then
            echo ""
            echo "✓ Bypass Secret obtained: ${SECRET:0:20}..."
            echo ""
            echo "Testing access with bypass..."
            
            # Test with the secret
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "x-vercel-protection-bypass: $SECRET" \
              https://frontend-hr3ntphz4-jasons-projects-c908ddc9.vercel.app)
            
            echo "HTTP Status with bypass header: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ SUCCESS - App accessible with bypass!"
            fi
          else
            echo "✗ Could not obtain bypass secret"
          fi
      
      - name: List existing bypass secrets
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "=== Checking for existing bypass secrets ===" 
          curl -s -X GET "https://api.vercel.com/v10/projects/$VERCEL_PROJECT_ID/protection-bypass" \
            -H "Authorization: Bearer $VERCEL_TOKEN" | jq '.'
